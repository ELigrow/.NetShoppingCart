@using NorthWindWeek5.Models
@using System.Data.Entity
@using NorthWindWeek5.Security
@{
    ViewBag.Title = "Cart";
    ViewBag.Total = (decimal)0.00;
}

<h2>My Cart</h2>

<table id="orderTable" class="table table-hover table-responsive">
    @{
        using (NorthwindEntities db = new NorthwindEntities())
        {
            var id = UserAccount.GetUserId();
            var results = db.Carts
                .Where(c => c.CustomerID == id)
                .ToList();

            if (results.Any())
            {
                <thead>
                    <tr>
                        <th class="font-md">Product</th>
                        <th class="text-right">Quantity</th>
                        <th class="text-right">Price</th>
                    </tr>
                </thead>
                <tbody>


                    @foreach (Cart c in results)
                    {
                    var name = db.Products
                    .Where(p => p.ProductID == c.ProductID)
                    .Select(p => p.ProductName).FirstOrDefault();

                    var price = (db.Products
                    .Where(p => p.ProductID == c.ProductID)
                    .Select(p => p.UnitPrice)
                    .FirstOrDefault() * Convert.ToDecimal(c.Quantity))
                    .ToString();

                    ViewBag.Total += Convert.ToDecimal(price);

                    <tr>
                        <td>@name</td>
                        <td class="text-right">@c.Quantity</td>
                        <td class="text-right">$@price.Substring(0, price.Length - 2)</td>
                    </tr>
                    }
                </tbody>
                <tfoot>
                    <tr>
                        <td></td>
                        <td class="text-right font-md">Total:</td>
                        <!--This is where the total is generated-->
                        <td class="text-right font-md">$@Math.Round(ViewBag.Total, 2)</td>
                    </tr>
                </tfoot>
                }
            }
        }
            </table>

<div id="empty"></div>

<nav id="nav-footer" class="navbar-default navbar-fixed-bottom">
    <form action="~/Cart/CheckOut">
        <button type="submit" class="btn btn-info pull-right" style="margin-right: 3em">
            Check out
            <i class="fa fa-chevron-circle-right"></i>
        </button>
    </form>


</nav>

@section scripts{
    <script>
        $(function () {

            if ($('#orderTable').length < 2) {
                $('#nav-footer').hide();
                $('#empty').html('Your cart is empty!');
            }

        });
    </script>
}